&НаСервереБезКонтекста

Функция CustomerPost(Запрос)
	ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку();
	Попытка
        Данные = ЧтениеJSON(ТелоЗапроса);
    Исключение
        Ответ = Новый HTTPСервисОтвет(400, "Incorrect JSON format");
        Возврат Ответ;
    КонецПопытки;

    // Проверка обязательных полей
    Если Не Данные.Свойство("fullName") Или Не Данные.Свойство("phone") Тогда
        Ответ = Новый HTTPСервисОтвет(400, "Обязательные поля: fullName, phone");
        Возврат Ответ;
    КонецЕсли;

    // Создаем структуру для контакта с Telegram username
    ПараметрыКонтакт = Новый Структура;
    ПараметрыКонтакт.Вставить("Имя", Данные.fullName);
    ПараметрыКонтакт.Вставить("Никнейм", Данные.username);

    Если Данные.Свойство("username") Тогда
        ПараметрыКонтакт.Вставить("ИдКонтакта", Данные.username);
        ПараметрыКонтакт.Вставить("Заметки", "Telegram: @" + Данные.username);
    Иначе
        ПараметрыКонтакт.Вставить("ИдКонтакта", "");
        ПараметрыКонтакт.Вставить("Заметки", "");
	КонецЕсли;

    // Создаем/находим контакт
    Контакт = Неопределено;
    Попытка
        Контакт = НайтиСоздатьКонтакт(ПараметрыКонтакт);
    Исключение
        ЗаписьЖурналаРегистрации("Ошибка создания контакта: " + ОписаниеОшибки(), УровеньЖурналаРегистрации.Ошибка);
        Ответ = Новый HTTPСервисОтвет(500, "Ошибка создания контакта");
        Возврат Ответ;
    КонецПопытки;

    // Модификация контрагента
	ВидКонтрагентаФизЛицо = Перечисления.ВидыКонтрагентов.ФизическоеЛицо;
	ГруппаДоступаКлиентскаяБаза = НайтиГруппуДоступа("Клиентская база");

    Покупатель = НайтиСоздатьКонтрагента(Контакт, Данные.phone, Неопределено);

    Если Покупатель <> Неопределено И Покупатель.Контрагент <> Неопределено Тогда
        Попытка
            КонтрагентОбъект = Покупатель.Контрагент.ПолучитьОбъект();

			КонтрагентОбъект.НаименованиеПолное = Данные.fullName;
			КонтрагентОбъект.ВидКонтрагента = ВидКонтрагентаФизЛицо;
			КонтрагентОбъект.ГруппаДоступа = ГруппаДоступаКлиентскаяБаза;
            КонтрагентОбъект.Покупатель = Истина;
            КонтрагентОбъект.Комментарий = "Telegram: @" + Данные.username;

			КонтрагентОбъект.Записать();
        Исключение
            ЗаписьЖурналаРегистрации("Ошибка обновления контрагента: " + ОписаниеОшибки(),
                                    УровеньЖурналаРегистрации.Ошибка);
        КонецПопытки;
    КонецЕсли;

	// Ответ
    ОтветДанные = Новый Структура;
    ОтветДанные.Вставить("Success", Истина);

    Если Покупатель <> Неопределено Тогда
        Если Покупатель.Контрагент <> Неопределено Тогда
            ДанныеКонтрагента = Новый Структура;
            ДанныеКонтрагента.Вставить("FullName", Покупатель.Контрагент.Наименование);
            Попытка
                ДанныеКонтрагента.Вставить("Url", Строка(Покупатель.Контрагент.УникальныйИдентификатор()));
            Исключение
                ДанныеКонтрагента.Вставить("Url", "");
            КонецПопытки;
            ОтветДанные.Вставить("Counteragent", ДанныеКонтрагента);
        КонецЕсли;
    КонецЕсли;

	Попытка
        JSONОтвет = ЗаписьJSON(ОтветДанные);
    Исключение
        ЗаписьЖурналаРегистрации("Ошибка сериализации JSON: " + ОписаниеОшибки(), УровеньЖурналаРегистрации.Ошибка);
        Ответ = Новый HTTPСервисОтвет(500, "Ошибка формирования ответа");
        Возврат Ответ;
    КонецПопытки;

    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
    Ответ.УстановитьТелоИзСтроки(JSONОтвет);
    Возврат Ответ;
КонецФункции

Функция PingGet(Запрос)
	Ответ = Новый HTTPСервисОтвет(200);
	Ответ.УстановитьТелоИзСтроки("Working");
	Возврат Ответ;
КонецФункции


// Контрагенты
Функция НайтиСоздатьКонтакт(Параметры)
	ИсточникПривлечения = "Telegram";

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КонтактныеЛицаКонтактнаяИнформация.Ссылка КАК Ссылка,
	|	КонтактныеЛицаКонтактнаяИнформация.ДоменноеИмяСервера КАК ДоменноеИмяСервера,
	|	КонтактныеЛицаКонтактнаяИнформация.Значение КАК Значение,
	|	КонтактныеЛицаКонтактнаяИнформация.Представление КАК Представление
	|ИЗ
	|	Справочник.КонтактныеЛица.КонтактнаяИнформация КАК КонтактныеЛицаКонтактнаяИнформация
	|ГДЕ
	|	КонтактныеЛицаКонтактнаяИнформация.Тип = &Тип
	|	И КонтактныеЛицаКонтактнаяИнформация.Вид = &Вид
	|	И ПОДСТРОКА(КонтактныеЛицаКонтактнаяИнформация.Ссылка.Комментарий, 1, 30) = &Заметки";

	Запрос.УстановитьПараметр("Тип", Перечисления.ТипыКонтактнойИнформации.Другое);
	Запрос.УстановитьПараметр("Вид", Справочники.ВидыКонтактнойИнформации.МессенджерКонтактногоЛица);
	Запрос.УстановитьПараметр("ДоменноеИмяСервера", ИсточникПривлечения);
	Запрос.УстановитьПараметр("Заметки", Параметры.ИдКонтакта);//Формат(ПоляЧата.Получить("id"),"ЧГ=0"));

	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();

	Если Выборка.Количество() = 0 Тогда

		Контакт = Справочники.КонтактныеЛица.СоздатьЭлемент();
		Контакт.Наименование = Параметры.Имя;
		Контакт.Комментарий = Параметры.ИдКонтакта;

		УправлениеКонтактнойИнформацией.ДобавитьКонтактнуюИнформацию(Контакт, ИсточникПривлечения + ": @" + Параметры.Никнейм,
			Справочники.ВидыКонтактнойИнформации.МессенджерКонтактногоЛица, ТекущаяДатаСеанса(), Истина);

		Попытка
			Контакт.Записать();

			Возврат Контакт.Ссылка;
		Исключение
		КонецПопытки;

	Иначе
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;

КонецФункции

Функция НайтиСоздатьКонтрагента(Контакт, Телефон, ДокументОбъект)

	ПокупательСсылка = КонтактнаяИнформацияУНФ.КонтрагентПоНомеруТелефона(Телефон); //, Истина, Ложь, Ложь);
	ДоговорПоУмолчанию = Неопределено;
	СтруктураВозврата = Новый Структура;

	Если ПокупательСсылка = Неопределено Тогда
		СтруктураВозврата = СоздатьКонтрагентаДоговор(Контакт, Телефон, ДокументОбъект);
	ИначеЕсли ТипЗнч(ПокупательСсылка) = Тип("СправочникСсылка.Контрагенты") Тогда
		ДоговорПоУмолчанию = Справочники.ДоговорыКонтрагентов.ДоговорПоУмолчанию(ПокупательСсылка);
		СтруктураВозврата.Вставить("Контрагент", ПокупательСсылка);
		СтруктураВозврата.Вставить("Договор", ДоговорПоУмолчанию);
	ИначеЕсли ТипЗнч(ПокупательСсылка) = Тип("СправочникСсылка.КонтактныеЛица") Тогда
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	СвязиКонтрагентКонтактСрезПоследних.Контрагент КАК Контрагент,
		|	ОсновныеДоговорыКонтрагента.Договор КАК Договор
		|ИЗ
		|	РегистрСведений.СвязиКонтрагентКонтакт.СрезПоследних КАК СвязиКонтрагентКонтактСрезПоследних
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОсновныеДоговорыКонтрагента КАК ОсновныеДоговорыКонтрагента
		|		ПО СвязиКонтрагентКонтактСрезПоследних.Контрагент = ОсновныеДоговорыКонтрагента.Контрагент
		|ГДЕ
		|	СвязиКонтрагентКонтактСрезПоследних.Контакт = &Контакт
		|	И НЕ СвязиКонтрагентКонтактСрезПоследних.СвязьНедействительна
		|	И ОсновныеДоговорыКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоров.СПокупателем)
		|	И СвязиКонтрагентКонтактСрезПоследних.Контрагент.КонтактноеЛицо = &Контакт";
		Запрос.УстановитьПараметр("Контакт", ПокупательСсылка);
		Результат = Запрос.Выполнить();
		Если Результат.Пустой() Тогда

			СтруктураВозврата = СоздатьКонтрагентаДоговор(Контакт, Телефон, ДокументОбъект);

		Иначе

			Выборка = Результат.Выбрать();
			Пока Выборка.Следующий() Цикл
				СтруктураВозврата.Вставить("Контрагент", Выборка.Контрагент);
				СтруктураВозврата.Вставить("Договор", Выборка.Договор);
				Прервать;
			КонецЦикла;

		КонецЕсли;

		Если ПокупательСсылка <> Контакт Тогда
			 РегистрыСведений.СвязиКонтрагентКонтакт.НоваяСвязь(Выборка.Контрагент, Контакт);
		КонецЕсли;

	ИначеЕсли ТипЗнч(ПокупательСсылка) = Тип("СправочникСсылка.Лиды") Тогда
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	СвязиКонтрагентЛид.Контрагент КАК Контрагент,
		|	ОсновныеДоговорыКонтрагента.Договор КАК Договор
		|ИЗ
		|	РегистрСведений.СвязиКонтрагентЛид КАК СвязиКонтрагентЛид
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОсновныеДоговорыКонтрагента КАК ОсновныеДоговорыКонтрагента
		|		ПО СвязиКонтрагентЛид.Контрагент = ОсновныеДоговорыКонтрагента.Договор
		|ГДЕ
		|	СвязиКонтрагентЛид.Лид = &Лид";
		Запрос.УстановитьПараметр("Лид", ПокупательСсылка);
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			СтруктураВозврата.Вставить("Контрагент", Выборка.Контрагент);
			СтруктураВозврата.Вставить("Договор", Выборка.Договор);
			Прервать;
		КонецЦикла;

		РегистрыСведений.СвязиКонтрагентКонтакт.НоваяСвязь(Выборка.Контрагент, Контакт);

	КонецЕсли;

	Возврат СтруктураВозврата;

КонецФункции

Функция СоздатьКонтрагентаДоговор(Контакт, Телефон, ДокументОбъект)

	КонтрагентОбъект = Справочники.Контрагенты.СоздатьЭлемент();

	СтруктураЗаполнения = Новый Структура;
	СтруктураЗаполнения.Вставить("Наименование", Контакт.Наименование);
	СтруктураЗаполнения.Вставить("НомерТелефона", Телефон);

	КонтрагентОбъект.Заполнить(СтруктураЗаполнения);
	КонтрагентОбъект.Покупатель = Истина;
	КонтрагентОбъект.КонтактноеЛицо = Контакт;
	КонтрагентОбъект.Записать();
	ПокупательСсылка = КонтрагентОбъект.Ссылка;

	СписокВидовДоговора = Новый СписокЗначений;
	СписокВидовДоговора.Добавить(Перечисления.ВидыДоговоров.СПокупателем);
	ДоговорПоУмолчанию = Справочники.ДоговорыКонтрагентов.ПоКонтрагентуПоОрганизации(КонтрагентОбъект.Ссылка,
		Справочники.Организации.ОсновнаяОрганизация, СписокВидовДоговора);
	Если Не ЗначениеЗаполнено(ДоговорПоУмолчанию) Тогда

		Договор = Справочники.ДоговорыКонтрагентов.СоздатьЭлемент();
		Договор.ВалютаРасчетов = ДокументОбъект.ВалютаДокумента;
		Договор.Организация = ДокументОбъект.Организация;
		Договор.ВидДоговора = Перечисления.ВидыДоговоров.СПокупателем;
		Договор.ВидЦен = ДокументОбъект.ВидЦен;
		Договор.Владелец = КонтрагентОбъект.Ссылка;
		Договор.СрокОплатыПоставщику = Константы.СрокОплатыПоставщику.Получить();
		Договор.СрокОплатыПокупателя = Константы.СрокОплатыПокупателя.Получить();
		Если ПустаяСтрока(Договор.Наименование) Тогда
			Договор.Наименование = ШаблоныНаименований.НаименованиеДоговораПоУмолчанию(Договор);
		КонецЕсли;
		Договор.Записать();
		ДоговорПоУмолчанию = Договор.Ссылка;

		Справочники.ДоговорыКонтрагентов.ЗаписатьДоговорПоУмолчанию(Договор);

	КонецЕсли;

	//УправлениеКонтактнойИнформацией.ДобавитьКонтактнуюИнформацию(ПокупательСсылка, Телефон,
	//	Справочники.ВидыКонтактнойИнформации.ТелефонКонтрагента, ТекущаяДатаСеанса(), Истина);

	РегистрыСведений.СвязиКонтрагентКонтакт.НоваяСвязь(ПокупательСсылка, Контакт);

	Возврат Новый Структура("Контрагент, Договор", ПокупательСсылка, ДоговорПоУмолчанию);

КонецФункции

Функция НайтиГруппуДоступа(НаименованиеГруппы)
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |   ГруппыДоступаКонтрагентов.Ссылка КАК Ссылка
    |ИЗ
    |   Справочник.ГруппыДоступаКонтрагентов КАК ГруппыДоступаКонтрагентов
    |ГДЕ
    |   ГруппыДоступаКонтрагентов.Наименование = &Наименование";

    Запрос.УстановитьПараметр("Наименование", НаименованиеГруппы);
    Результат = Запрос.Выполнить().Выбрать();

    Если Результат.Следующий() Тогда
        Возврат Результат.Ссылка;
    КонецЕсли;

    Возврат Неопределено;
КонецФункции

Функция ЧтениеJSON(Данные)
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(Данные);
    Возврат ПрочитатьJSON(ЧтениеJSON);
КонецФункции

Функция ЗаписьJSON(Данные)

	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Данные);
	Возврат ЗаписьJSON.Закрыть();

КонецФункции

Функция CustomerPut(Запрос)
	ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку();
    Попытка
        Данные = ЧтениеJSON(ТелоЗапроса);
    Исключение
        Ответ = Новый HTTPСервисОтвет(400, "Incorrect JSON format");
        Возврат Ответ;
    КонецПопытки;

    // Проверка обязательного поля code (5 цифр)
    Если Не Данные.Свойство("code") Тогда
        Ответ = Новый HTTPСервисОтвет(400, "Required field: code (5 digits)");
        Возврат Ответ;
    КонецЕсли;

    // Инициализация данных
    ВидКонтрагентаФизЛицо = Перечисления.ВидыКонтрагентов.ФизическоеЛицо;
    ГруппаДоступаКлиентскаяБаза = НайтиГруппуДоступа("Клиентская база");

    // Определяем телефон для поиска
    Если Данные.Свойство("phone") И ЗначениеЗаполнено(Данные.phone) Тогда
        ТелефонДляПоиска = Данные.phone;
        ИспользоватьВременныйТелефон = Ложь;
    Иначе
        ТелефонДляПоиска = Данные.code; // Используем code как временный телефон
        ИспользоватьВременныйТелефон = Истина;
    КонецЕсли;

    // Поиск существующего контрагента
    ПокупательСсылка = КонтактнаяИнформацияУНФ.КонтрагентПоНомеруТелефона(ТелефонДляПоиска);

    // Создаем структуру для контакта
    ПараметрыКонтакт = Новый Структура;
    ПараметрыКонтакт.Вставить("Имя", ?(Данные.Свойство("fullName"), Данные.fullName, "Клиент #" + Данные.code));
    ПараметрыКонтакт.Вставить("Никнейм", ?(Данные.Свойство("username"), Данные.username, ""));

    Если Данные.Свойство("username") Тогда
        ПараметрыКонтакт.Вставить("ИдКонтакта", Данные.username);
    Иначе
        ПараметрыКонтакт.Вставить("ИдКонтакта", "");
    КонецЕсли;

    // Создаем/находим контакт
    Контакт = Неопределено;
    Попытка
        Контакт = НайтиСоздатьКонтакт(ПараметрыКонтакт);
    Исключение
        ЗаписьЖурналаРегистрации("Ошибка создания контакта: " + ОписаниеОшибки(), УровеньЖурналаРегистрации.Ошибка);
        Ответ = Новый HTTPСервисОтвет(500, "Error create counteragent");
        Возврат Ответ;
    КонецПопытки;

    Покупатель = Новый Структура("Контрагент, Договор", ПокупательСсылка, Неопределено);

    // Обновление данных контрагента
    Если Покупатель <> Неопределено И Покупатель.Контрагент <> Неопределено Тогда
        Попытка
            КонтрагентОбъект = Покупатель.Контрагент.ПолучитьОбъект();

            // Обновляем основные данные
            Если Данные.Свойство("fullName") Тогда
                КонтрагентОбъект.НаименованиеПолное = Данные.fullName;
            КонецЕсли;

            КонтрагентОбъект.ВидКонтрагента = ВидКонтрагентаФизЛицо;
            КонтрагентОбъект.ГруппаДоступа = ГруппаДоступаКлиентскаяБаза;
            КонтрагентОбъект.Покупатель = Истина;

            // Обновляем username в комментарии
            Если Данные.Свойство("username") Тогда
                КонтрагентОбъект.Комментарий = "Telegram: @" + Данные.username;
            КонецЕсли;

            // Если был временный телефон (code) и теперь указан phone - обновляем
            Если ИспользоватьВременныйТелефон = Ложь Тогда
                // Проверяем, был ли сохранен code как временный телефон
                Если ЗначениеЗаполнено(КонтрагентОбъект.ОсновнойТелефон) И КонтрагентОбъект.ОсновнойТелефон = Данные.code Тогда
                    // Заменяем временный телефон на настоящий
                    КонтрагентОбъект.ОсновнойТелефон = Данные.phone;
                КонецЕсли;

                // Добавляем/обновляем телефон в контактной информации
                УправлениеКонтактнойИнформацией.ДобавитьКонтактнуюИнформацию(
                    КонтрагентОбъект.Ссылка,
                    Данные.phone,
                    Справочники.ВидыКонтактнойИнформации.ТелефонКонтрагента,
                    ТекущаяДата(),
                    Истина
                );
            КонецЕсли;

            КонтрагентОбъект.Записать();
        Исключение
            ЗаписьЖурналаРегистрации("Ошибка обновления контрагента: " + ОписаниеОшибки(),
                                    УровеньЖурналаРегистрации.Ошибка);
        КонецПопытки;
    КонецЕсли;

    // Формирование ответа (остается без изменений)
    ОтветДанные = Новый Структура;
    ОтветДанные.Вставить("Success", Истина);
    ОтветДанные.Вставить("Code", Данные.code);

    Если Покупатель <> Неопределено И Покупатель.Контрагент <> Неопределено Тогда
        ДанныеКонтрагента = Новый Структура;
        ДанныеКонтрагента.Вставить("FullName", Покупатель.Контрагент.Наименование);
        Попытка
            ДанныеКонтрагента.Вставить("Url", Строка(Покупатель.Контрагент.УникальныйИдентификатор()));
        Исключение
            ДанныеКонтрагента.Вставить("Url", "");
        КонецПопытки;
        ОтветДанные.Вставить("Counteragent", ДанныеКонтрагента);
    КонецЕсли;

    Попытка
        JSONОтвет = ЗаписьJSON(ОтветДанные);
    Исключение
        ЗаписьЖурналаРегистрации("Ошибка сериализации JSON: " + ОписаниеОшибки(), УровеньЖурналаРегистрации.Ошибка);
        Ответ = Новый HTTPСервисОтвет(500, "Error forming response");
        Возврат Ответ;
    КонецПопытки;

    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
    Ответ.УстановитьТелоИзСтроки(JSONОтвет);
    Возврат Ответ;
КонецФункции



Функция ПолучитьСписокТелефонов()
    Перем ЛогСообщение;
    Результат = Новый Структура("new,used", Новый Массив, Новый Массив);

    Попытка
        // Получаем группы через иерархию
        ГруппаNewIPhone = НайтиГруппуЧерезИерархию("New iPhone");
        ГруппаUsedIPhone = НайтиГруппуЧерезИерархию("Used iPhone");

        Если ГруппаNewIPhone = Неопределено Или ГруппаUsedIPhone = Неопределено Тогда
            ВызватьИсключение "Не найдены группы: " +
                            ?(ГруппаNewIPhone = Неопределено, "New iPhone", "") +
                            ?(ГруппаUsedIPhone = Неопределено, ?(ГруппаNewIPhone = Неопределено, ", ", "") + "Used iPhone", "");
        КонецЕсли;

        // Формируем массив ссылок на группы
        МассивГрупп = Новый Массив;
        МассивГрупп.Добавить(ГруппаNewIPhone);
        МассивГрупп.Добавить(ГруппаUsedIPhone);

        // Основной запрос без фильтрации по остаткам
        Запрос = Новый Запрос;
        Запрос.Текст =
        "ВЫБРАТЬ
        |   Номенклатура.Ссылка КАК Ссылка,
        |   Номенклатура.Наименование КАК Наименование,
        |   Номенклатура.Родитель КАК Родитель
        |ИЗ
        |   Справочник.Номенклатура КАК Номенклатура
        |ГДЕ
        |   Номенклатура.Родитель В(&МассивГрупп)
        |   И Номенклатура.ЭтоГруппа = ЛОЖЬ
        |   И Номенклатура.ТипНоменклатуры = &ТипНоменклатуры
        |   И Номенклатура.КатегорияНоменклатуры.Наименование = &Категория";

        Запрос.УстановитьПараметр("МассивГрупп", МассивГрупп);
        Запрос.УстановитьПараметр("ТипНоменклатуры", Перечисления.ТипыНоменклатуры.Запас);
        Запрос.УстановитьПараметр("Категория", "Смартфоны");

        Выборка = Запрос.Выполнить().Выбрать();

        Пока Выборка.Следующий() Цикл
            Если Выборка.Родитель = ГруппаNewIPhone Тогда
                Результат.new.Добавить(Выборка.Ссылка);
            ИначеЕсли Выборка.Родитель = ГруппаUsedIPhone Тогда
                Результат.used.Добавить(Выборка.Ссылка);
            КонецЕсли;
        КонецЦикла;

        // Фильтрация по остаткам
        Результат.new = ФильтроватьПоОстаткам(Результат.new);
        Результат.used = ФильтроватьПоОстаткам(Результат.used);

        // Преобразуем ссылки обратно в наименования
        Результат.new = ПреобразоватьСсылкиВНаименования(Результат.new);
        Результат.used = ПреобразоватьСсылкиВНаименования(Результат.used);

        ЗаписьЖурналаРегистрации("Найдено новых iPhone: " + Результат.new.Количество() + ", подержанных: " + Результат.used.Количество(),
                                УровеньЖурналаРегистрации.Информация);

    Исключение
        ЗаписьЖурналаРегистрации("Ошибка при получении списка телефонов: " + ОписаниеОшибки(), УровеньЖурналаРегистрации.Ошибка);
        ВызватьИсключение;
    КонецПопытки;

    Возврат Результат;
КонецФункции

Функция ФильтроватьПоОстаткам(МассивСсылок)
    Результат = Новый Массив;

    Для Каждого Ссылка Из МассивСсылок Цикл
        Если ЕстьОстатки(Ссылка) Тогда
            Результат.Добавить(Ссылка);
        КонецЕсли;
    КонецЦикла;

    Возврат Результат;
КонецФункции

Функция ЕстьОстатки(СсылкаНоменклатуры)

    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |   СУММА(ОстаткиТоваров.Количество) КАК Количество
    |ИЗ
    |   РегистрСведений.ОстаткиТоваров КАК ОстаткиТоваров
    |ГДЕ
    |   ОстаткиТоваров.Номенклатура = &Ссылка
    |   И ОстаткиТоваров.Количество > 0";

    Запрос.УстановитьПараметр("Ссылка", СсылкаНоменклатуры);

    Результат = Запрос.Выполнить().Выбрать();

    Попытка
        Если Результат.Следующий() Тогда
            // Явное преобразование и проверка на NULL
            КоличествоОстатков = ?(Результат.Количество = Неопределено, 0, Число(Результат.Количество));
            Возврат КоличествоОстатков > 0;
        КонецЕсли;
    Исключение
        ЗаписьЖурналаРегистрации("Ошибка при проверке остатков: " + ОписаниеОшибки(),
                                УровеньЖурналаРегистрации.Ошибка);
        Возврат Ложь;
    КонецПопытки;

    Возврат Ложь;

КонецФункции

Функция ПреобразоватьСсылкиВНаименования(МассивСсылок)
    Результат = Новый Массив;

    Для Каждого Ссылка Из МассивСсылок Цикл
        Результат.Добавить(Ссылка.Наименование);
    КонецЦикла;

    Возврат Результат;
КонецФункции

Функция НайтиГруппуЧерезИерархию(НаименованиеГруппы)
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |   ИерархияНоменклатуры.Номенклатура КАК Ссылка
    |ИЗ
    |   РегистрСведений.ИерархияНоменклатуры КАК ИерархияНоменклатуры
    |ГДЕ
    |   ИерархияНоменклатуры.Номенклатура.Наименование = &Наименование
    |   И ИерархияНоменклатуры.Номенклатура.ЭтоГруппа = ИСТИНА";

    Запрос.УстановитьПараметр("Наименование", НаименованиеГруппы);

    Результат = Запрос.Выполнить().Выбрать();
    Если Результат.Следующий() Тогда
        Возврат Результат.Ссылка;
    КонецЕсли;

    Возврат Неопределено;
КонецФункции

Функция PhonesGet(Запрос)
	Отладка();
    ДанныеТелефонов = Неопределено;
    Успех = Ложь;
    ТекстОшибки = "";

    Попытка
        ДанныеТелефонов = ПолучитьСписокТелефонов();
        Успех = Истина;
    Исключение
        ТекстОшибки = ОписаниеОшибки();
        ДанныеТелефонов = Новый Структура("new,used", Новый Массив, Новый Массив);
    КонецПопытки;

    Ответ = Новый Структура;
    Ответ.Вставить("success", Успех);
    Ответ.Вставить("error", ?(Успех, Неопределено, ТекстОшибки));
    Ответ.Вставить("data", ДанныеТелефонов);

    JSONОтвет = ЗаписьJSON(Ответ);

    HTTPОтвет = Новый HTTPСервисОтвет(?(Успех, 200, 500));
    HTTPОтвет.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
    HTTPОтвет.УстановитьТелоИзСтроки(JSONОтвет);

    Возврат HTTPОтвет;
КонецФункции


Функция Отладка()
	Попытка
		Запрос = Новый Запрос;
	    Запрос.Текст =
	    "ВЫБРАТЬ
	    |	ОстаткиТоваров.Номенклатура
	    |   ИЗ
	    |   	РегистрСведений.ОстаткиТоваров КАК ОстаткиТоваров
	    |   ГДЕ
	    |       ОстаткиТоваров.Номенклатура = Номенклатура.Ссылка
	    |       И ОстаткиТоваров.Количество > 0";

	    Запрос.УстановитьПараметр("ТипНоменклатуры", Перечисления.ТипыНоменклатуры.Запас);
	    Запрос.УстановитьПараметр("Категория", "Смартфоны");

	    Выборка = Запрос.Выполнить().Выбрать();


		ЗаписьЖурналаРегистрации("Получение списка телефонов, количество: " + Выборка.Количество(), УровеньЖурналаРегистрации.Примечание);
    Исключение
        ЗаписьЖурналаРегистрации("Ошибка при получении списка телефонов: " + ОписаниеОшибки(), УровеньЖурналаРегистрации.Ошибка);
        ВызватьИсключение;
    КонецПопытки;

КонецФункции


